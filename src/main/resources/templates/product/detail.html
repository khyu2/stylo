<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="ko"
      layout:decorate="~{layout/base}">
<head>
    <title th:text="${product.name}">상품 상세</title>
</head>
<body>
<div layout:fragment="content">
    <div class="bg-base-100">
        <div class="container mx-auto px-4 py-8">
            <!-- Page Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold" th:text="${product.name}">상품명</h1>
                <p class="text-lg opacity-70 mt-2" th:text="${product.description ?: '상품 설명이 없습니다.'}">상품 설명</p>
            </div>

            <!-- Admin Actions -->
            <div sec:authorize="hasRole('ADMIN')" class="flex justify-center mb-6">
                <div class="flex gap-2">
                    <a th:href="@{'/products/' + ${product.productId} + '/edit'}"
                       class="btn btn-outline btn-primary">
                        <i data-lucide="edit" class="h-4 w-4 mr-2"></i>수정
                    </a>
                    <form th:action="@{'/products/' + ${product.productId} + '/delete'}" method="post" class="inline">
                        <button type="submit"
                                onclick="return confirm('정말로 이 상품을 삭제하시겠습니까?')"
                                class="btn btn-outline btn-error">
                            <i data-lucide="trash-2" class="h-4 w-4 mr-2"></i>삭제
                        </button>
                    </form>
                </div>
            </div>

            <!-- Product Content -->
            <div class="max-w-6xl mx-auto">
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Product Image Gallery -->
                            <div class="space-y-4">
                                <!-- Main Image -->
                                <div class="bg-base-200 rounded-lg h-96 flex items-center justify-center overflow-hidden">
                                    <img id="mainImage"
                                         th:src="${product.productImages != null ? product.productImages[0] : '/images/default_product.jpeg'}"
                                         alt="상품 이미지"
                                         class="w-full h-full object-cover rounded-lg">
                                </div>

                                <!-- Product Images -->
                                <div th:if="${product.productImages != null and !product.productImages.isEmpty()}"
                                     class="space-y-3">
                                    <h3 class="text-lg font-semibold">상품 이미지</h3>
                                    <div class="flex gap-3 overflow-x-auto p-2">
                                        <!-- Main product image thumbnail -->
                                        <div class="flex-shrink-0">
                                            <img th:src="${product.productImages != null ? product.productImages[0] : '/images/default_product.jpeg'}"
                                                 alt="메인 이미지"
                                                 onclick="changeMainImage(this.src, this)"
                                                 class="w-20 h-20 object-cover rounded-lg border-2 border-primary cursor-pointer hover:scale-105 transition-transform">
                                        </div>

                                        <!-- Additional product images -->
                                        <div th:each="image, iterStat : ${product.productImages}"
                                             th:if="${iterStat.index > 0}"
                                             class="flex-shrink-0">
                                            <img th:src="${image}" th:alt="'상품 이미지'"
                                                 onclick="changeMainImage(this.src, this)"
                                                 class="w-20 h-20 object-cover rounded-lg border-2 border-base-300 cursor-pointer hover:scale-105 hover:border-primary transition-all">
                                        </div>
                                    </div>
                                </div>

                                <!-- No additional images message -->
                                <div th:if="${product.productImages == null or product.productImages.isEmpty()}"
                                     class="text-center py-4">
                                    <p class="text-sm text-base-content/60">추가 이미지가 없습니다.</p>
                                </div>
                            </div>

                            <!-- Product Info -->
                            <div class="space-y-6">
                                <!-- Price -->
                                <div class="card bg-base-200">
                                    <div class="card-body p-6">
                                        <div class="text-center">
                                            <span class="text-4xl font-bold text-primary"
                                                  th:text="${'₩' + #numbers.formatDecimal(product.price, 1, 'COMMA', 0, 'POINT')}">₩0</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stock Status -->
                                <div class="flex items-center justify-center gap-2">
                                    <span class="text-sm font-medium">재고:</span>
                                    <span th:if="${product.totalStock > 0}"
                                          class="badge badge-info badge-lg"
                                          th:text="${product.totalStock + '개'}">재고 있음</span>
                                    <span th:if="${product.totalStock <= 0}"
                                          class="badge badge-error badge-lg">품절</span>
                                </div>

                                <!-- Product Details -->
                                <div class="card bg-base-100">
                                    <div class="card-body p-4">
                                        <h3 class="card-title text-lg mb-4">상품 정보</h3>
                                        <div class="space-y-3">
                                            <div class="flex justify-between">
                                                <span class="text-sm text-base-content/70">상품 ID</span>
                                                <span class="text-sm font-medium"
                                                      th:text="${product.productId}">-</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-sm text-base-content/70">등록일</span>
                                                <span class="text-sm font-medium"
                                                      th:text="${#temporals.format(product.createdAt, 'yyyy-MM-dd HH:mm')}">-</span>
                                            </div>
                                            <div th:if="${product.updatedAt != null}" class="flex justify-between">
                                                <span class="text-sm text-base-content/70">수정일</span>
                                                <span class="text-sm font-medium"
                                                      th:text="${#temporals.format(product.updatedAt, 'yyyy-MM-dd HH:mm')}">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="space-y-4">
                                    <form th:if="${product.totalStock > 0}" th:action="@{/cart/add}" method="post"
                                          class="space-y-4">
                                        <input type="hidden" name="productId" th:value="${product.productId}">

                                        <!-- Product Options -->
                                        <div th:if="${product.options != null and !product.options.isEmpty()}"
                                             class="space-y-4">
                                            <h3 class="text-lg font-semibold">상품 옵션</h3>

                                            <!-- ProductOptionId-based options dropdown -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text font-medium">옵션 선택</span>
                                                </label>
                                                <select name="productOptionId"
                                                        id="optionSelect"
                                                        class="select select-bordered w-full"
                                                        onchange="updateSelectedOption()">
                                                    <option value="">옵션을 선택해주세요</option>
                                                    <option th:each="option : ${product.options}"
                                                            th:value="${option.productOptionId}"
                                                            th:data-additional-price="${option.additionalPrice}"
                                                            th:data-stock="${option.stock}"
                                                            th:text="${option.optionValue + (option.additionalPrice > 0 ? ' (+₩' + #numbers.formatDecimal(option.additionalPrice, 1, 'COMMA', 0, 'POINT') + ')' : '') + ' - 재고: ' + option.stock + '개'}">
                                                        옵션 값
                                                    </option>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Selected Option Info -->
                                        <div id="selectedOptionInfo" class="hidden">
                                            <div class="alert alert-info">
                                                <i data-lucide="info" class="h-4 w-4"></i>
                                                <div class="flex-1">
                                                    <div class="flex justify-between items-center w-full">
                                                        <span class="text-sm font-medium">선택된 옵션:</span>
                                                        <span id="selectedOptionText" class="text-sm"></span>
                                                    </div>
                                                    <div id="additionalPriceInfo" class="text-sm mt-1"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Quantity Selector -->
                                        <div class="form-control">
                                            <label class="label mr-4">
                                                <span class="label-text font-medium">수량</span>
                                            </label>
                                            <div class="join w-full max-w-xs">
                                                <button type="button"
                                                        onclick="updateQuantity(-1)"
                                                        class="btn btn-outline join-item">
                                                    <i data-lucide="minus" class="h-4 w-4"></i>
                                                </button>
                                                <input type="number"
                                                       name="quantity"
                                                       id="quantity"
                                                       value="1"
                                                       min="1"
                                                       max="99"
                                                       class="input input-bordered join-item w-20 text-center">
                                                <button type="button"
                                                        onclick="updateQuantity(1)"
                                                        class="btn btn-outline join-item">
                                                    <i data-lucide="plus" class="h-4 w-4"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div sec:authorize="isAuthenticated()" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            <button type="button" onclick="toggleWishlist()" class="btn btn-ghost w-full btn-lg">
                                                <i data-lucide="heart" class="h-5 w-5 mr-2"></i>찜하기
                                            </button>
                                            <button type="submit"
                                                    id="addToCartBtn"
                                                    class="btn btn-primary w-full btn-lg">
                                                <i data-lucide="shopping-cart" class="h-5 w-5 mr-2"></i>장바구니에 추가
                                            </button>
                                        </div>
                                    </form>

                                    <button th:if="${product.totalStock <= 0}"
                                            disabled
                                            class="btn btn-disabled w-full btn-lg">
                                        <i data-lucide="x-circle" class="h-5 w-5 mr-2"></i>품절
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Back to Home -->
            <div class="text-center mt-8">
                <a href="/"
                   class="btn btn-ghost">
                    <i data-lucide="arrow-left" class="h-4 w-4 mr-2"></i>
                    홈으로 돌아가기
                </a>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="scripts" th:inline="javascript">
    function toggleWishlist() {
        const form = document.createElement('form');
        form.method = 'post';
        form.action = '/wishlist/toggle';

        const productIdInput = document.createElement('input');
        productIdInput.type = 'hidden';
        productIdInput.name = 'productId';
        productIdInput.value = '[[${product.productId}]]';

        form.appendChild(productIdInput);
        document.body.appendChild(form);
        form.submit();
    }

    function changeMainImage(src, clickedElement = null) {
        const mainImage = document.getElementById('mainImage');
        mainImage.src = src;

        const thumbnails = document.querySelectorAll('img[onclick*="changeMainImage"]');
        thumbnails.forEach(thumb => {
            thumb.classList.remove('border-primary');
            thumb.classList.add('border-base-300');
        });

        if (clickedElement) {
            clickedElement.classList.remove('border-base-300');
            clickedElement.classList.add('border-primary');
        }
    }

    function updateQuantity(change) {
        const quantityInput = document.getElementById('quantity');
        const currentQuantity = parseInt(quantityInput.value);
        const newQuantity = Math.max(1, Math.min(99, currentQuantity + change));
        quantityInput.value = newQuantity;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const optionSelect = document.getElementById('optionSelect');
        const addToCartBtn = document.getElementById('addToCartBtn');

        if (!optionSelect) {
            // 옵션이 없는 상품의 경우 버튼 활성화
            addToCartBtn.disabled = false;
            addToCartBtn.classList.remove('btn-disabled');
            addToCartBtn.classList.add('btn-primary');
        }
    });

    function updateSelectedOption() {
        const selectedOptionInfo = document.getElementById('selectedOptionInfo');
        const selectedOptionText = document.getElementById('selectedOptionText');
        const additionalPriceInfo = document.getElementById('additionalPriceInfo');
        const addToCartBtn = document.getElementById('addToCartBtn');
        const optionSelect = document.getElementById('optionSelect');

        if (optionSelect && optionSelect.value) {
            const selectedOption = optionSelect.options[optionSelect.selectedIndex];
            const optionText = selectedOption.textContent.split(' - ')[0]; // 재고 정보 제외
            const additionalPrice = parseFloat(selectedOption.dataset.additionalPrice) || 0;

            selectedOptionText.textContent = optionText;
            additionalPriceInfo.textContent = additionalPrice > 0 ? `추가 금액: +₩${additionalPrice.toLocaleString()}` : '추가 금액: ₩0';

            selectedOptionInfo.classList.remove('hidden');
            addToCartBtn.disabled = false;
            addToCartBtn.classList.remove('btn-disabled');
            addToCartBtn.classList.add('btn-primary');
        } else {
            selectedOptionText.textContent = '옵션을 선택해주세요.';
            additionalPriceInfo.textContent = '추가 금액: ₩0';

            selectedOptionInfo.classList.add('hidden');
            addToCartBtn.disabled = true;
            addToCartBtn.classList.remove('btn-primary');
            addToCartBtn.classList.add('btn-disabled');
        }
    }

    document.querySelector('form').addEventListener('submit', function (e) {
        const optionSelect = document.getElementById('optionSelect');

        if (optionSelect && optionSelect.value === '') {
            e.preventDefault();
            alert('옵션을 선택해주세요.');
            return;
        }

        // productOptionId와 quantity는 이미 폼에 포함되어 있음
        // 추가적인 hidden input은 필요하지 않음
    });
</script>
</body>
</html>
