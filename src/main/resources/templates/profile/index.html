<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/base}">
<head>
    <title>프로필 - Stylo</title>
</head>
<body>
<div layout:fragment="content" x-data="profilePage()">
    <div class="min-h-screen p-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Flash Messages -->
            <div th:if="${success}" class="mb-6 bg-green-50 border border-green-200 rounded-md p-4">
                <div class="flex">
                    <i data-lucide="check-circle" class="w-5 h-5 text-green-400 mr-3"></i>
                    <p class="text-sm text-green-800" th:text="${success}"></p>
                </div>
            </div>
            <div th:if="${error}" class="mb-6 bg-red-50 border border-red-200 rounded-md p-4">
                <div class="flex">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-red-400 mr-3"></i>
                    <p class="text-sm text-red-800" th:text="${error}"></p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Sidebar -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 lg:p-6">
                        <!-- Profile Photo Section -->
                        <div class="text-center mb-6">
                            <div class="relative inline-block">
                                <div class="w-20 h-20 lg:w-24 lg:h-24 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                                    <img th:id="profileImage"
                                         th:src="${#authentication.principal.profileUrl != null ? #authentication.principal.profileUrl : '/default_profile.jpeg'}"
                                         alt="프로필 사진" class="w-full h-full object-cover">
                                </div>
                                <!-- Camera Button -->
                                <button type="button" @click="$refs.profileImageInput.click()"
                                        class="absolute -bottom-1 -right-1 bg-blue-600 text-white rounded-full p-1.5 hover:bg-blue-700 transition-colors">
                                    <i data-lucide="camera" class="w-3 h-3"></i>
                                </button>
                                <!-- Delete Button -->
                                <button type="button" @click="deleteProfileImage()"
                                        class="absolute -bottom-1 -right-6 bg-red-600 text-white rounded-full p-1.5 hover:bg-red-700 transition-colors"
                                        th:if="${#authentication.principal.profileUrl != null}">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                </button>
                                <!-- Hidden forms for file upload and delete -->
                                <form x-ref="uploadForm" action="/profile/upload-profile-image" method="post"
                                      enctype="multipart/form-data" class="hidden">
                                    <input type="file" x-ref="profileImageInput" name="image" accept="image/*"
                                           @change="uploadProfileImage($event)">
                                </form>
                                <form x-ref="deleteForm" action="/profile/delete-profile-image" method="post"
                                      class="hidden"></form>
                            </div>
                            <h3 class="mt-3 text-base lg:text-lg font-semibold text-gray-900"
                                sec:authentication="principal.member.name">사용자명</h3>
                            <p class="text-sm text-gray-500" sec:authentication="principal.member.email">
                                user@example.com</p>
                        </div>

                        <!-- Navigation -->
                        <nav class="space-y-1">
                            <button @click="activeTab = 'profile'"
                                    :class="activeTab === 'profile' ? 'text-blue-600 bg-blue-50' : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'"
                                    class="flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors w-full text-left">
                                <i data-lucide="user" class="w-4 h-4 mr-2"></i>
                                개인정보
                            </button>
                            <button @click="activeTab = 'address'"
                                    :class="activeTab === 'address' ? 'text-blue-600 bg-blue-50' : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'"
                                    class="flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors w-full text-left">
                                <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>
                                배송지 관리
                            </button>
                            <button @click="activeTab = 'security'"
                                    :class="activeTab === 'security' ? 'text-blue-600 bg-blue-50' : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'"
                                    class="flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors w-full text-left">
                                <i data-lucide="shield" class="w-4 h-4 mr-2"></i>
                                보안 설정
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="lg:col-span-3">
                    <!-- Profile Information -->
                    <div x-show="activeTab === 'profile'"
                         x-transition:enter="transition ease-out duration-300"
                         x-transition:enter-start="opacity-0 transform translate-y-4"
                         x-transition:enter-end="opacity-100 transform translate-y-0"
                         x-transition:leave="transition ease-in duration-200"
                         x-transition:leave-start="opacity-100 transform translate-y-0"
                         x-transition:leave-end="opacity-0 transform translate-y-4"
                         class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-4 lg:px-6 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-900">개인정보</h2>
                            <p class="text-sm text-gray-600">기본적인 개인정보를 수정할 수 있습니다</p>
                        </div>
                        <div class="p-4 lg:p-6">
                            <form th:action="@{/profile/update}" method="post" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 lg:gap-6">
                                    <div>
                                        <label for="email"
                                               class="block text-sm font-medium text-gray-700 mb-2">이메일</label>
                                        <input type="email" id="email" name="email" disabled
                                               th:value="${member.email}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-300">
                                    </div>
                                    <div>
                                        <label for="name"
                                               class="block text-sm font-medium text-gray-700 mb-2">이름</label>
                                        <input type="text" id="name" name="name"
                                               th:value="${member.name}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                
                                <!-- 마케팅 수신 동의 -->
                                <div class="border-t border-gray-200 pt-6">
                                    <h3 class="text-lg font-medium text-gray-900 mb-4">마케팅 정보 수신</h3>
                                    <div class="space-y-4">
                                        <div class="flex items-start">
                                            <div class="flex items-center h-5">
                                                <input type="checkbox" id="isMarketing" name="isMarketing" 
                                                       th:checked="${member.isMarketing}"
                                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            </div>
                                            <div class="ml-3 text-sm">
                                                <label for="isMarketing" class="font-medium text-gray-700">마케팅 정보 수신 동의</label>
                                                <p class="text-gray-500">새로운 상품, 할인 정보, 이벤트 소식을 이메일과 SMS로 받아보세요.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end">
                                    <button type="submit"
                                            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                        정보 수정
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Address Management -->
                    <div x-show="activeTab === 'address'"
                         x-transition:enter="transition ease-out duration-300"
                         x-transition:enter-start="opacity-0 transform translate-y-4"
                         x-transition:enter-end="opacity-100 transform translate-y-0"
                         x-transition:leave="transition ease-in duration-200"
                         x-transition:leave-start="opacity-100 transform translate-y-0"
                         x-transition:leave-end="opacity-0 transform translate-y-4"
                         class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-4 lg:px-6 py-4 border-b border-gray-200">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-900">배송지 관리</h2>
                                    <p class="text-sm text-gray-600">배송지를 추가하고 관리할 수 있습니다</p>
                                </div>
                                <button class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors text-sm w-full sm:w-auto"
                                        @click="openAddressModal()">
                                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                    배송지 추가
                                </button>
                            </div>
                        </div>
                        <div class="p-4 lg:p-6">
                            <!-- Default Address -->
                            <div class="mb-6">
                                <h3 class="text-md font-medium text-gray-900 mb-4">기본 배송지</h3>
                                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4">
                                        <div class="flex-1">
                                            <div class="flex items-center mb-2">
                                                <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full mr-2">기본</span>
                                                <span class="font-medium text-gray-900">홍길동</span>
                                            </div>
                                            <p class="text-gray-600 text-sm mb-1">010-1234-5678</p>
                                            <p class="text-gray-600 text-sm">서울특별시 강남구 테헤란로 123, 456호 (우편번호: 06123)</p>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button class="text-gray-400 hover:text-blue-600 transition-colors">
                                                <i data-lucide="edit" class="w-4 h-4"></i>
                                            </button>
                                            <button class="text-gray-400 hover:text-red-600 transition-colors">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Other Addresses -->
                            <div>
                                <h3 class="text-md font-medium text-gray-900 mb-4">추가 배송지</h3>
                                <div class="space-y-4">
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4">
                                            <div class="flex-1">
                                                <div class="flex items-center mb-2">
                                                    <span class="font-medium text-gray-900">김철수</span>
                                                </div>
                                                <p class="text-gray-600 text-sm mb-1">010-9876-5432</p>
                                                <p class="text-gray-600 text-sm">부산광역시 해운대구 해운대로 456, 789호 (우편번호:
                                                    48000)</p>
                                            </div>
                                            <div class="flex space-x-2">
                                                <button class="text-gray-400 hover:text-blue-600 transition-colors">
                                                    <i data-lucide="edit" class="w-4 h-4"></i>
                                                </button>
                                                <button class="text-gray-400 hover:text-red-600 transition-colors">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div x-show="activeTab === 'security'"
                         x-transition:enter="transition ease-out duration-300"
                         x-transition:enter-start="opacity-0 transform translate-y-4"
                         x-transition:enter-end="opacity-100 transform translate-y-0"
                         x-transition:leave="transition ease-in duration-200"
                         x-transition:leave-start="opacity-100 transform translate-y-0"
                         x-transition:leave-end="opacity-0 transform translate-y-4"
                         class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-4 lg:px-6 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-900">보안 설정</h2>
                            <p class="text-sm text-gray-600">비밀번호 변경 및 보안 설정을 관리합니다</p>
                        </div>
                        <div class="p-4 lg:p-6">
                            <form th:action="@{/profile/change-password}" method="post" class="space-y-6" x-ref="passwordForm" @submit="validatePasswordForm($event)">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 lg:gap-6">
                                    <div>
                                        <label for="currentPassword"
                                               class="block text-sm font-medium text-gray-700 mb-2">현재 비밀번호</label>
                                        <input type="password" id="currentPassword" name="currentPassword" required
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div></div>
                                    <div>
                                        <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">새
                                            비밀번호</label>
                                        <input type="password" id="newPassword" name="newPassword" required minlength="8" maxlength="20"
                                               @input="checkPasswordMatch()"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <p class="text-xs text-gray-500 mt-1">8자 이상 20자 이하로 입력해주세요.</p>
                                    </div>
                                    <div>
                                        <label for="confirmPassword"
                                               class="block text-sm font-medium text-gray-700 mb-2">새 비밀번호 확인</label>
                                        <input type="password" id="confirmPassword" name="confirmPassword" required
                                               @input="checkPasswordMatch()"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <p x-show="passwordMismatch" class="text-xs text-red-500 mt-1">비밀번호가 일치하지 않습니다.</p>
                                    </div>
                                </div>
                                <div class="flex justify-end">
                                    <button type="submit"
                                            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                        비밀번호 변경
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Address Modal -->
    <div x-show="addressModalOpen"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4"
         @click.away="closeAddressModal()"
         @keydown.escape.window="closeAddressModal()">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full" @click.stop>
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">배송지 추가</h3>
            </div>
            <form x-ref="addressForm" action="/profile/add-address" method="post" class="p-6 space-y-4">
                <div>
                    <label for="addressName" class="block text-sm font-medium text-gray-700 mb-2">배송지명</label>
                    <input type="text" id="addressName" name="name" x-model="addressForm.name"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="recipientName" class="block text-sm font-medium text-gray-700 mb-2">수령인</label>
                    <input type="text" id="recipientName" name="recipientName" x-model="addressForm.recipientName"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="recipientPhone" class="block text-sm font-medium text-gray-700 mb-2">연락처</label>
                    <input type="tel" id="recipientPhone" name="phone" x-model="addressForm.phone"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="postalCode" class="block text-sm font-medium text-gray-700 mb-2">우편번호</label>
                    <div class="flex space-x-2">
                        <input type="text" id="postalCode" name="postalCode" x-model="addressForm.postalCode"
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button type="button"
                                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors">
                            검색
                        </button>
                    </div>
                </div>
                <div>
                    <label for="address1" class="block text-sm font-medium text-gray-700 mb-2">기본주소</label>
                    <input type="text" id="address1" name="address1" x-model="addressForm.address1"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="address1" class="block text-sm font-medium text-gray-700 mb-2">상세주소</label>
                    <input type="text" id="address2" name="address2" x-model="addressForm.address2"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="isDefault" name="isDefault" x-model="addressForm.isDefault"
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="isDefault" class="ml-2 block text-sm text-gray-700">기본 배송지로 설정</label>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" @click="closeAddressModal()"
                            class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors">
                        취소
                    </button>
                    <button type="submit"
                            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">저장
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script layout:fragment="scripts">
    function profilePage() {
        return {
            activeTab: 'profile', // 기본 탭
            addressModalOpen: false,
            passwordMismatch: false,
            notification: {
                show: false,
                message: '',
                type: 'success'
            },
            addressForm: {
                name: '',
                recipientName: '',
                phone: '',
                postalCode: '',
                address1: '',
                address2: '',
                isDefault: false
            },

            openAddressModal() {
                this.addressModalOpen = true;
            },

            closeAddressModal() {
                this.addressModalOpen = false;
                this.resetAddressForm();
            },

            resetAddressForm() {
                this.addressForm = {
                    name: '',
                    recipientName: '',
                    phone: '',
                    postalCode: '',
                    address1: '',
                    address2: '',
                    isDefault: false
                };
            },

            submitAddress() {
                // 배송지 저장 로직
                console.log('배송지 저장:', this.addressForm);
                // Form을 사용하여 서버로 직접 요청
                this.$refs.addressForm.submit();
                this.closeAddressModal();
            },

            uploadProfileImage(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Form을 사용하여 서버로 직접 요청
                this.$refs.uploadForm.submit();
            },

            deleteProfileImage() {
                if (confirm('프로필 사진을 삭제하시겠습니까?')) {
                    this.$refs.deleteForm.submit();
                }
            },

            validatePasswordForm(event) {
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (newPassword !== confirmPassword) {
                    this.passwordMismatch = true;
                    event.preventDefault();
                    return false;
                }
                
                this.passwordMismatch = false;
                return true;
            },

            checkPasswordMatch() {
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                this.passwordMismatch = !!(confirmPassword && newPassword !== confirmPassword);
            }
        }
    }
</script>
</body>
</html>
