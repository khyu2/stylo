<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:x-bind="http://www.w3.org/1999/xhtml"
      lang="ko"
      layout:decorate="~{layout/base}">
<head>
    <title>주문서 - Stylo</title>
</head>
<body>
<div layout:fragment="content">
    <div class="container mx-auto px-4 py-8">
        <!-- Page Header -->
        <div class="mb-8 text-center">
            <h1 class="text-4xl font-bold">주문서</h1>
        </div>

        <!-- Empty State -->
        <div th:if="${cartItems == null or cartItems.isEmpty()}" class="text-center py-16">
            <div class="max-w-md mx-auto">
                <i data-lucide="shopping-cart" class="h-16 w-16 text-base-content/30 mx-auto mb-4"></i>
                <h3 class="text-lg font-medium mb-2">주문할 상품이 없습니다</h3>
                <p class="opacity-70 mb-6">장바구니에서 상품을 담아 주문을 진행해 주세요.</p>
                <a href="/" class="btn btn-primary btn-lg">
                    <i data-lucide="shopping-bag" class="h-5 w-5 mr-2"></i>
                    쇼핑하러 가기
                </a>
            </div>
        </div>

        <!-- Order Form & Summary -->
        <form th:if="${cartItems != null and !cartItems.isEmpty()}" th:action="@{/orders/create}" method="post"
              class="grid grid-cols-1 lg:grid-cols-3 gap-6" x-data="{ addrChoice: 'NEW' }"
              x-init="addrChoice = document.querySelector('input[name=\'addrChoice\']:checked')?.value || 'NEW'">
            <!-- Address -->
            <input type="hidden"
                   x-bind:name="addrChoice !== 'NEW' ? 'addressId' : null"
                   x-bind:value="addrChoice !== 'NEW' ? addrChoice : null"/>
            <!-- Cart items -->
            <div class="hidden">
                <div th:each="item, iter : ${cartItems}">
                    <input type="hidden" th:name="${'cartItems[' + iter.index + '].productOptionId'}"
                           th:value="${item.productOptionId}"/>
                    <input type="hidden" th:name="${'cartItems[' + iter.index + '].quantity'}"
                           th:value="${item.quantity}"/>
                </div>
                <input type="hidden" name="paymentMethod" id="paymentMethodInput"/>
            </div>
            <!-- Left: Order Form -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Shipping Address Selection -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body p-6 space-y-4">
                        <div class="flex items-center justify-between">
                            <h2 class="card-title">배송지 선택</h2>
                            <span class="badge badge-ghost" th:if="${addresses != null}"
                                  th:text="${addresses.size()} + '개'">0개</span>
                        </div>

                        <!-- Address list -->
                        <div th:if="${addresses != null and !addresses.isEmpty()}" class="space-y-3">
                            <label th:each="addr, iterStat : ${addresses}"
                                   class="flex items-start gap-3 p-4 border border-base-300 rounded-box hover:bg-base-200">
                                <input type="radio" name="addrChoice" class="radio radio-primary mt-1"
                                       th:value="${addr.addressId}"
                                       th:checked="${addr.defaultAddress or iterStat.index == 0}"
                                       x-model="addrChoice">
                                <div class="flex-1">
                                    <div class="flex items-center mb-2">
                                                    <span th:if="${addr.defaultAddress}"
                                                          class="badge badge-primary badge-sm mr-2">기본</span>
                                        <span class="font-medium" th:text="${addr.recipient}">수령인</span>
                                    </div>
                                    <p class="text-sm opacity-70 mb-1" th:text="${addr.phone}">연락처</p>
                                    <p class="text-sm opacity-70 mb-1">
                                        <span th:text="${addr.address}">주소</span>
                                        <span th:if="${addr.addressDetail != null}"
                                              th:text="', ' + ${addr.addressDetail}">상세주소</span>
                                        <span th:text="' (우편번호: ' + ${addr.postalCode} + ')'">우편번호</span>
                                    </p>
                                    <p class="text-sm opacity-70 truncate" th:if="${addr.requestMessage}"
                                       th:text="${'요청사항 : ' + addr.requestMessage}">요청사항</p>
                                </div>
                            </label>
                        </div>
                        <div th:if="${addresses == null or addresses.isEmpty()}" class="alert">
                            <i data-lucide="map-pin" class="h-5 w-5"></i>
                            <span>등록된 배송지가 없습니다. 아래에서 새 배송지를 입력해 주세요.</span>
                        </div>

                        <!-- New address -->
                        <div class="collapse bg-base-200 border rounded-box"
                             :class="addrChoice === 'NEW' ? 'border-primary' : 'border-base-300'">
                            <input type="radio" name="addrChoice" value="NEW" x-model="addrChoice"/>
                            <div class="collapse-title text-md font-medium">새 주소로 배송</div>
                            <div class="collapse-content">
                                <div class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="form-control w-full">
                                            <label for="recipient" class="label"><span
                                                    class="label-text">이름</span></label>
                                            <input type="text" id="recipient" name="addressRequest.recipient"
                                                   class="input input-bordered w-full"
                                                   placeholder="홍길동"/>
                                        </div>
                                        <div class="form-control w-full">
                                            <label for="phone" class="label"><span class="label-text">연락처</span></label>
                                            <input type="tel" id="phone" name="addressRequest.phone"
                                                   class="input input-bordered w-full"
                                                   placeholder="010-1234-5678"/>
                                        </div>
                                    </div>
                                    <div class="form-control w-full">
                                        <label for="postalCode" class="label"><span
                                                class="label-text">우편번호</span></label>
                                        <input type="text" id="postalCode" name="addressRequest.postalCode"
                                               class="input input-bordered w-full"
                                               placeholder="12345"/>
                                    </div>
                                    <div class="form-control w-full">
                                        <label for="address" class="label"><span class="label-text">주소</span></label>
                                        <input type="text" id="address" name="addressRequest.address"
                                               class="input input-bordered w-full"
                                               placeholder="도로명 주소"/>
                                    </div>
                                    <div class="form-control w-full">
                                        <label for="addressDetail" class="label"><span
                                                class="label-text">상세 주소</span></label>
                                        <input type="text" id="addressDetail" name="addressRequest.addressDetail"
                                               class="input input-bordered w-full"
                                               placeholder="동/호수 등"/>
                                    </div>
                                    <div class="form-control w-full">
                                        <label for="requestMessage" class="label"><span
                                                class="label-text">배송 요청사항</span></label>
                                        <textarea id="requestMessage" name="addressRequest.requestMessage"
                                                  class="textarea textarea-bordered w-full"
                                                  rows="3"
                                                  placeholder="문 앞에 놓아주세요"></textarea>
                                    </div>
                                    <div class="form-control w-full">
                                        <label class="label cursor-pointer justify-start gap-3">
                                            <!--                                            <input type="hidden" name="addressRequest.defaultAddress" value="false" />-->
                                            <input type="checkbox" class="checkbox checkbox-primary"
                                                   name="addressRequest.defaultAddress"/>
                                            <span class="label-text">기본 배송지로 저장</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Summary -->
            <div class="lg:col-span-1">
                <div class="card bg-base-100 shadow-xl sticky top-6">
                    <div class="card-body p-6 space-y-4">
                        <h2 class="card-title">주문 요약</h2>
                        <div class="divide-y divide-base-300">
                            <div th:each="item : ${cartItems}" class="py-3 flex items-center gap-3">
                                <img th:src="${item.thumbnailUrl != null ? item.thumbnailUrl : '/images/default_product.jpeg'}"
                                     th:alt="${item.name}" class="w-12 h-12 rounded-lg object-cover">
                                <div class="flex-1 min-w-0">
                                    <p class="truncate" th:text="${item.getDisplayName()}">상품명</p>
                                    <p class="text-sm opacity-70" th:text="${'수량: ' + item.quantity}">수량</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-medium"
                                       th:text="${'₩' + #numbers.formatDecimal(item.getTotalPrice(), 1, 'COMMA', 0, 'POINT')}">
                                        ₩0</p>
                                </div>
                            </div>
                        </div>

                        <div class="pt-2 space-y-1 text-sm">
                            <div class="flex justify-between"><span>상품 합계</span><span
                                    th:text="${'₩' + #numbers.formatDecimal(#aggregates.sum(cartItems.![totalPrice]), 1, 'COMMA', 0, 'POINT')}">₩0</span>
                            </div>
                            <div class="flex justify-between"><span>배송비</span><span>₩0</span></div>
                            <div class="flex justify-between font-semibold text-primary mt-1"><span>총 결제 금액</span><span
                                    th:text="${'₩' + #numbers.formatDecimal(#aggregates.sum(cartItems.![totalPrice]), 1, 'COMMA', 0, 'POINT')}">₩0</span>
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary btn-lg w-full"
                                onclick="openModal('checkoutModal'); initTossPayment();">
                            <i data-lucide="credit-card" class="h-5 w-5 mr-2"></i>
                            결제하기
                        </button>
                        <a href="/cart" class="btn btn-ghost w-full">장바구니로 돌아가기</a>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- 결제 모달 -->
    <dialog id="checkoutModal" class="modal">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg mb-2">결제</h3>
            <p class="opacity-70 text-sm mb-4">아래에서 결제 수단을 선택하고 약관에 동의해주세요.</p>
            <div id="payment-method"></div>
            <div id="agreement" class="mt-4"></div>
            <div class="modal-action">
                <button id="payment-button" class="btn btn-primary">결제하기</button>
                <form method="dialog">
                    <button class="btn btn-ghost">닫기</button>
                </form>
            </div>
        </div>
    </dialog>
</div>

<th:block layout:fragment="scripts">
    <script src="https://js.tosspayments.com/v2/standard"></script>
    <script th:inline="javascript">
        function openModal(id) {
            const dlg = document.getElementById(id);
            if (!dlg) return;
            if (typeof dlg.showModal === 'function') {
                dlg.showModal();
            } else {
                dlg.setAttribute('open', '');
            }
        }

        async function initTossPayment() {
            // ------  결제위젯 초기화 ------
            const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
            const tossPayments = TossPayments(clientKey);

            // 회원 결제
            const customerKey = /*[[${#authentication.name}]]*/ "UNKNOWN_USER";
            const widgets = tossPayments.widgets({customerKey});
            // 비회원 결제
            // const widgets = tossPayments.widgets({ customerKey: TossPayments.ANONYMOUS });

            // ------ 주문의 결제 금액 설정 ------
            await widgets.setAmount({
                currency: "KRW",
                value: /*[[${#aggregates.sum(cartItems.![totalPrice])}]]*/ 50000,
            });

            const [paymentMethodWidget] = await Promise.all([
                // ------  결제 UI 렌더링 ------
                widgets.renderPaymentMethods({
                    selector: "#payment-method",
                    variantKey: "DEFAULT",
                }),
                // ------  이용약관 UI 렌더링 ------
                widgets.renderAgreement({selector: "#agreement", variantKey: "AGREEMENT"}),
            ]);

            // ------ '결제하기' 버튼 누르면 결제창 띄우기 ------
            document.getElementById("payment-button").onclick = async function () {
                const modal = document.getElementById("checkoutModal");
                if (modal) {
                    modal.close();
                }

                const paymentMethod = await paymentMethodWidget.getSelectedPaymentMethod();
                const paymentMethodType = paymentMethod.code;

                // 주문 생성: 기존 주문 폼의 데이터를 수집하여 서버로 전송
                const form = document.querySelector('form[action="/orders/create"]') || document.querySelector('form');
                if (!form) {
                    console.error('Order form not found.');
                    return;
                }

                // hidden input 에 paymentMethod 설정
                const pmInput = document.getElementById('paymentMethodInput');
                if (pmInput) pmInput.value = paymentMethodType;

                // FormData -> URLSearchParams 로 변환하여 x-www-form-urlencoded 로 전송
                const fd = new FormData(form);
                const params = new URLSearchParams();
                fd.forEach((value, key) => {
                    if (value != null) params.append(key, value.toString());
                });

                try {
                    const response = await fetch('/orders/create', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'},
                        body: params.toString()
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Order creation failed:', errorText);
                        alert('주문 생성에 실패했습니다. 다시 시도해주세요.');
                        return;
                    }

                    const data = await response.json();

                    await widgets.requestPayment({
                        orderId: data.orderId,
                        orderName: data.orderName,
                        successUrl: window.location.origin + "/payment/success",
                        failUrl: window.location.origin + "/payment/fail",
                        customerEmail: data.customerEmail,
                        customerName: data.customerName,
                        customerMobilePhone: data.sanitizedPhone,
                    });
                } catch (e) {
                    console.error('주문 생성 요청 실패', e);
                }
            };
        }
    </script>
</th:block>
</body>
</html>
